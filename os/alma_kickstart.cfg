#version=EL10
####################################################
# INFO
#  at least 1 disk with at least 20GB is required
####################################################

####################################################
# (anaconda)
####################################################
# specify password poliy during setup
#%anaconda
#pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
#pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
#pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
#%end
####################################################

####################################################
# (pre) repo.cfg
####################################################
# run a pre script to detect the DVD label and
# use it with the harddrive syntax instead of cdrom
# this makes the script very flexible and usable for
# different ISOs.
%pre --erroronfail
 LABEL=$(blkid -s LABEL | grep -i dvd | sed 's@.*LABEL="\(.*\)"@\1@g')
 echo "harddrive --partition=LABEL=$LABEL --dir=/" >> /tmp/repo.cfg
%end
# run the repo.cfg preinstallation script
%include /tmp/repo.cfg
####################################################

####################################################
# (pre) part-include.cfg
####################################################
# DISK PARTITIONING (dynamic split)
%pre --interpreter=/bin/bash --erroronfail
# THE CODE BELOW SHOULD WORK FOR EFI AND MBR
# SINCE WE USE THE 'reqpart --add-boot' COMMAND
# detect if EFI or not
#IS_EFI=0
#if [ -d /sys/firmware/efi ]; then
#  IS_EFI=1
#fi
# Detect the primary disk name (non-USB, non-CDROM) and store it as $DISK (e.g. sda)
for d in $(ls /sys/block/ | grep -E '^sd|^nvme'); do
    if [ "$(cat /sys/block/$d/removable)" -eq 0 ]; then
        DISK=$d
        break
    fi
done
# Fallback using /proc/partitions if /sys/block is insufficient
[ -z "$DISK" ] && DISK=$(awk '$4 ~ /^sd|^nvme/ {print $4; exit}' /proc/partitions)
# log result
DEVICE="/dev/$DISK"
echo "Detected disk: $DEVICE" > /tmp/disk-detect.log

# prepare for autopartitioning
# calculate sizes
DISKSIZE=$(cat /sys/block/$DISK/size) # size in 512byte blocks
DISKSIZEMB=$(( DISKSIZE/2048 ))      # size in MBytes
OSMB=$(( DISKSIZEMB/8 ))             # size of / in MBytes
if [ ${OSMB} -lt 8192 ]; then OSMB=8192; fi

#if [ $IS_EFI -eq 1 ]; then
cat > /tmp/part-include.cfg << EOF
 ignoredisk --only-use=$DISK
 # Bootloader options
 # = disable spectre and meltdown mitigations
 #  --append="nopti noibrs noibpb rhgb quiet"
 bootloader --append="rhgb quiet"
 zerombr
 clearpart --all --initlabel
 reqpart --add-boot
 #part /boot/efi --fstype=efi --size=600 --ondisk=$DISK
 #part /boot --fstype=xfs --size=1024 --ondisk=$DISK
 part pv.01 --size=$OSMB --ondisk=$DISK
 part pv.02 --grow --ondisk=$DISK
 volgroup os pv.01
 volgroup data pv.02
 logvol swap   --fstype=swap --name=swap --vgname=os --size=2048
 logvol /      --fstype=xfs --name=root --vgname=os --size=4096 --grow
 logvol /data  --fstype=xfs --name=data --vgname=data --size=4096 --grow
EOF
#else
#cat > /tmp/part-include.cfg << EOF
# ignoredisk --only-use=$DISK
# bootloader --append="rhgb quiet"
# zerombr
#clearpart --all --initlabel
# reqpart --add-boot
# part pv.01 --size=$OSMB --ondisk=$DISK
# part pv.02 --grow --ondisk=$DISK
# volgroup os pv.01
# volgroup data pv.02
# logvol swap   --fstype=swap --name=swap --vgname=os --size=2048
# logvol /      --fstype=xfs --name=root --vgname=os --size=4096 --grow
# logvol /data  --fstype=xfs --name=data --vgname=data --size=4096 --grow
#EOF
#fi
%end
# run the part-include.cfg
%include /tmp/part-include.cfg
####################################################

# after %pre
# Root password (SHA-512 hashed)
# you can crypt with openssl passwd -6
# WeDeployMachines!
#rootpw --iscrypted $6$Ku4lmS/Zg7Iq3/50$S/SITuw3KPIZ.PXW967dBdK6xZd19eDi9wl6sN2Vq2veEfcjoGm6q4616w2RI94WyLml88jsO0u3OafeafBq3

# Admin user you can crypt the password with 'openssl passwd -6'
# password: IamtheSysadmin!
user --groups=wheel --name=pxeadm --password=$6$6xXYg49/klNaXj8m$WKZ1jhGvUyknCVCbdFkGoeM.FhAH5/HkIktUOGF5F/3vVAcNXn2V4hNTTQtSNmxlTviIZaAoBCUDCeokgBYS70 --iscrypted --gecos="admin"
lang en_US
keyboard --xlayouts='de'
timezone Europe/Berlin --utc
#rootpw $2b$10$LE/TypRR2TEvsjbldQcp7uQcrNVh.WZMNCG5YpzXaag0NKk67n61K --iscrypted
#reboot
poweroff
network  --bootproto=dhcp --device=link --noipv6 --activate
network  --hostname=pxe-host
skipx
# comment next line to enable GUI setup
text
firstboot --disable
selinux --enforcing
#firewall --enabled --ssh
####################################################
# (packages)
####################################################
%packages
@^minimal-environment
kexec-tools
NetworkManager-config-server
binutils
file
curl
wget
jq
lvm2
vim
unzip
bzip2
dos2unix
dosfstools
systemd-container
selinux-policy-sandbox
tar
git
%end
####################################################
# (post --nochroot) runs before post
####################################################
%post --nochroot --interpreter=/bin/bash
# --- Phase 1: Modify target system from installer environment ---
lan0_MAC=''
pxe0_MAC=''
# find NICs that have a carrier except 'lo'
NICS_UP=$(ip -brief -N -f link -o link | grep -v '^lo' | grep -v 'NO-CARRIER')
echo "NICS_UP: $NICS_UP"
# find NICs with that have no carrier except 'lo'
NICS_DOWN=$(ip -brief -N -f link -o link | grep -v '^lo' | grep 'NO-CARRIER')
echo "NICS_DOWN: $NICS_DOWN"
if [ $(echo "$NICS_UP" | wc -l) -eq 1 ] # if only 1 nic is up
then
        # make this NIC lan0
        lan0_MAC=$(echo "$NICS_UP" | awk '{print $3}')
else
        # make first NIC that is up lan0
        lan0_MAC=$(echo "$NICS_UP" | head -n 1 |awk '{print $3}')
fi
if [ $(echo "$NICS_DOWN" | wc -l) -eq 1 ] # if only 1 nic is down
then
        # make this NIC pxe0
        pxe0_MAC=$(echo "$NICS_DOWN" | awk '{print $3}')
else
        # make this NIC pxe0
        pxe0_MAC=$(echo "$NICS_DOWN" | head -n 1 | awk '{print $3}')
fi
echo "lan0_MAC: $lan0_MAC" >> /root/ks-summary.txt
echo "pxe0_MAC: $pxe0_MAC" >> /root/ks-summary.txt


# Create .link file in target system
# prerequisites in /mnt/sysroot
mkdir -p /mnt/sysroot/etc/systemd/network >/dev/null 2>&1
mkdir -p /mnt/sysroot/etc/NetworkManager/system-connections >/dev/null 2>&1
echo "created '/etc/NetworkManager/system-connections' for future system" >> /root/ks-summary.txt
# ############################################################################
# lan0
# ############################################################################
# create 70-lan0.link
cat << EOF > /mnt/sysroot/etc/systemd/network/70-lan0.link
[Match]
MACAddress=$lan0_MAC

[Link]
Name=lan0
EOF
echo "created '/etc/systemd/network/70-lan0.link' for future system" >> /root/ks-summary.txt
# ############################################################################
# pxe0
# ############################################################################
# create 70-pxe0.link
cat << EOF > /mnt/sysroot/etc/systemd/network/70-pxe0.link
[Match]
MACAddress=$pxe0_MAC

[Link]
Name=pxe0
EOF
echo "created '/etc/systemd/network/70-pxe0.link' for future system" >> /root/ks-summary.txt
# ############################################################################
# lan0
# ############################################################################
# Create a temporary NetworkManager profile for lan0 in installer environment
nmcli connection add type ethernet ifname lan0 con-name "lan0" autoconnect yes
nmcli connection modify "lan0" ipv4.method auto ipv6.method disabled

# ############################################################################
# pxe0
# ############################################################################
# Create a temporary NetworkManager profile for pxe0 in installer environment
# for a static IPv4 assignment
nmcli connection add type ethernet ifname pxe0 con-name "pxe0"
nmcli connection modify "pxe0" connection.autoconnect-priority -999
nmcli connection modify "pxe0" ipv4.addresses "192.168.124.1/24"
nmcli connection modify "pxe0" ipv4.method manual
nmcli connection modify "pxe0" ipv6.method disabled
nmcli connection modify "pxe0" ipv6.addr-gen-mode default

# remove possible automatically created *.nmconnection in future sysroot
rm -f /mnt/sysroot/etc/NetworkManager/system-connections/*.nmconnection >/dev/null 2>&1

# ############################################################################
# lan0
# ############################################################################
# Copy lan0 profile to target system
if [ -f /etc/NetworkManager/system-connections/lan0.nmconnection ]; then
    # copy lan0.nmconnection to future sysroot
    cp /etc/NetworkManager/system-connections/lan0.nmconnection /mnt/sysroot/etc/NetworkManager/system-connections/
    chmod 600 /mnt/sysroot/etc/NetworkManager/system-connections/lan0.nmconnection
else
    echo "Warning: lan0.nmconnection not found in installer environment" >> /mnt/sysroot/root/ks-warning.log
fi

# ############################################################################
# pxe0
# ############################################################################
# Copy pxe0 profile to target system
if [ -f /etc/NetworkManager/system-connections/pxe0.nmconnection ]; then
    # copy pxe0.nmconnection to future sysroot
    cp /etc/NetworkManager/system-connections/pxe0.nmconnection /mnt/sysroot/etc/NetworkManager/system-connections/
    chmod 600 /mnt/sysroot/etc/NetworkManager/system-connections/pxe0.nmconnection
else
    echo "Warning: pxe0.nmconnection not found in installer environment" >> /mnt/sysroot/root/ks-warning.log
fi
echo "copied NetworkManager network profiles for lan0 and pxe0 to future system" >> /root/ks-summary.txt

# Rebuild initramfs in target system for name stability
# chroot /mnt/sysroot dracut -f
%end
####################################################

####################################################
# (post)
####################################################
# --- Phase 2: Finalize inside chroot ---
%post --interpreter=/bin/bash
##
## %post runs in the chroot of the installed system, not the live installer environment.
##
echo "Installation completed." >> /root/ks-summary.txt
echo "Profiles for lan0 and pxe0 created." >> /root/ks-summary.txt

# Rebuild initramfs so NIC rename applies early in boot
dracut -f
%end
####################################################
